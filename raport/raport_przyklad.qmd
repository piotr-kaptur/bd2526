---
title: "Raport: Analiza Chomików Sportowych"
subtitle: "Analiza danych z bazy Team13"
lang: pl
date-format: short
title-block-style: plain
title-block-banner: "#33ffa3"
title-block-banner-color: "#0b4600"
toc-location: right
format: 
  html:
    code-fold: true
    self-contained: true
    theme: cosmo
jupyter: python3
execute:
  daemon: false
  warning: false
---

```{python}
#| label: load_packages
#| include: false
import sqlalchemy as sa
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.automap import automap_base
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from datetime import date
from IPython.display import Markdown
import urllib.parse
from plotly.subplots import make_subplots
```

## Konfiguracja połączenia

```{python}
#| label: connection_data
#| include: true
# DANE LOGOWANIA
host = 'giniewicz.it'
user = 'team13'
password = 'te@mzie'
database = 'team13'
port = 3306
```

```{python}
#| label: connection_engine
#| include: false

# --- NAPRAWA HASŁA ---
safe_password = urllib.parse.quote_plus(password)
safe_user = urllib.parse.quote_plus(user)

connection_string = f"mariadb+pymysql://{safe_user}:{safe_password}@{host}:{port}/{database}?charset=utf8mb4"
engine = sa.create_engine(connection_string)

Base = automap_base()
Base.prepare(autoload_with=engine)
SessionLocal = sessionmaker(bind=engine)
session = SessionLocal()

Chomiki = Base.classes.chomiki
Zawody = Base.classes.zawody
Wyniki = Base.classes.wyniki_zawodow
Konkurencje = Base.classes.konkurencje
SponsorzyUmowy = Base.classes.sponsorzy_umowy
Finansowanie = Base.classes.finansowanie
Kontrole = Base.classes.kontrole
```

---

### 1. Najlepsi sportowcy w każdej kategorii

Poniższy wykres przedstawia chomiki, które osiągnęły najlepszy (najkrótszy) czas w poszczególnych konkurencjach.

```{python}
#| label: best_athletes
#| include: false

query_best = session.query(
    Konkurencje.nazwa_konkurencji,
    Chomiki.imie,
    Chomiki.rasa,
    sa.func.min(Wyniki.czas).label('najlepszy_czas')
).join(Zawody, Wyniki.id_zawodow == Zawody.id_zawodow)\
 .join(Konkurencje, Zawody.id_konkurencji == Konkurencje.id_konkurencji)\
 .join(Chomiki, Wyniki.id_chomika == Chomiki.id_chomika)\
 .group_by(Konkurencje.nazwa_konkurencji)

df_best = pd.read_sql_query(query_best.statement, engine)
```

```{python}
#| label: fig-best-barplot
#| fig-cap: "Rekordziści w poszczególnych konkurencjach"
#| echo: false

fig = px.bar(df_best, 
             x='nazwa_konkurencji', 
             y='najlepszy_czas', 
             color='rasa',
             text='imie',
             title="Najlepsze czasy według konkurencji",
             labels={'najlepszy_czas': 'Czas (s)', 'nazwa_konkurencji': 'Dyscyplina', 'rasa': 'Rasa'})

fig.update_traces(textposition='auto')
fig.update_layout(xaxis_tickangle=-45)
fig.show()
```

Wszyscy rekordziści, niezależnie od konkurencji, osiągają czasy w okolicy 15-16 sekund. Chomiki rasy chińskiej dzierżą najwięcej, bo aż 2 z 5 rekordów, jedynym rekordzistą niepochodzącym z azji jest chomik rasy europejskiej który dzierży rekord w biegu z przeszkodami.

### 2. Szczyt kariery chomików

Analiza zależności między wiekiem chomika a osiąganym czasem z podziałem na dyscypliny.

```{python}
#| label: career_peak
#| include: false

query_age = session.query(
    Wyniki.czas,
    Chomiki.data_urodzenia,
    Zawody.data_zawodow,
    Konkurencje.nazwa_konkurencji,
    Chomiki.rasa
).join(Chomiki, Wyniki.id_chomika == Chomiki.id_chomika)\
 .join(Zawody, Wyniki.id_zawodow == Zawody.id_zawodow)\
 .join(Konkurencje, Zawody.id_konkurencji == Konkurencje.id_konkurencji)

df_age = pd.read_sql_query(query_age.statement, engine)
df_age['wiek_dni'] = (pd.to_datetime(df_age['data_zawodow']) - pd.to_datetime(df_age['data_urodzenia'])).dt.days
```

```{python}
#| label: fig-career-peak-slider-discipline
#| fig-cap: "Zależność wyniku od wieku chomika"
#| echo: false

fig = go.Figure()

dyscypliny = df_age['nazwa_konkurencji'].unique()

rasy = df_age['rasa'].unique()
colors = px.colors.qualitative.Bold
color_map = {r: colors[i % len(colors)] for i, r in enumerate(rasy)}

for dysc in dyscypliny:
    df_d = df_age[df_age['nazwa_konkurencji'] == dysc]
    point_colors = df_d['rasa'].map(color_map)
    
    fig.add_trace(
        go.Scatter(
            x=df_d['wiek_dni'],
            y=df_d['czas'],
            mode='markers',
            name=dysc,
            text=df_d['rasa'],
            hovertemplate="<b>%{text}</b><br>Wiek: %{x} dni<br>Czas: %{y}s<extra></extra>",
            visible=False,
            marker=dict(
                size=8, 
                color=point_colors, 
                opacity=0.65
            )
        )
    )

if len(fig.data) > 0:
    fig.data[0].visible = True

buttons = []
for i, dysc in enumerate(dyscypliny):
    visibility = [False] * len(dyscypliny)
    visibility[i] = True
    
    button = dict(
        label=dysc,
        method="update",
        args=[{"visible": visibility},
              {"title": f"Wiek vs Czas: {dysc}"}]
    )
    buttons.append(button)

fig.update_layout(
    updatemenus=[dict(active=0, buttons=buttons, x=1.15, y=1.15)],
    title=f"Wiek vs Czas: {dyscypliny[0] if len(dyscypliny)>0 else ''}",
    xaxis_title="Wiek (dni)",
    yaxis_title="Czas (s)",
    xaxis=dict(
        rangeslider=dict(visible=True),
        type="linear"
    ),
    margin=dict(t=50, b=50)
)

fig.show()
```

**Wnioski:**

Analiza poszczególnych dyscyplin pokazuje, że wiek zawodnika nie jest czynnikiem limitującym wynik sportowy, niezależnie od charakteru konkurencji.

* **Długowieczność:** Zarówno w konkurencjach wymagających eksplozywnej energii ("Sprint prosty"), jak i technicznych ("Slalom tunelowy"), wykresy  przyjmują formę płaskiej chmury punktów. Oznacza to, że starsze chomiki (powyżej 800 dni) rywalizują jak równy z równym z młodzikami.
* **Brak "krzywej formy":** W przeciwieństwie do sportu ludzkiego, gdzie widoczny jest wyraźny szczyt formy i późniejszy regres, u chomików wydolność pozostaje stała przez całe życie.

### 3. Czy pieniądze dają przewagę?

Sprawdzamy, czy chomiki posiadające wyższe kontrakty sponsorskie osiągają lepsze czasy. Analiza została rozdzielona na oszczególne dyscypliny.

```{python}
#| label: money_vs_performance_advanced
#| include: false

query_sponsors = session.query(
    SponsorzyUmowy.id_chomika,
    sa.func.sum(SponsorzyUmowy.kwota).label('suma_sponsoringu')
    ).group_by(SponsorzyUmowy.id_chomika).subquery()

query_perf = session.query(
    Chomiki.imie,
    Chomiki.id_chomika,
    Konkurencje.nazwa_konkurencji,
    sa.func.avg(Wyniki.czas).label('sredni_czas')
).join(Zawody, Wyniki.id_zawodow == Zawody.id_zawodow)\
 .join(Konkurencje, Zawody.id_konkurencji == Konkurencje.id_konkurencji)\
 .join(Chomiki, Wyniki.id_chomika == Chomiki.id_chomika)\
 .group_by(Chomiki.id_chomika, Konkurencje.nazwa_konkurencji)

df_perf = pd.read_sql_query(query_perf.statement, engine)

df_money = pd.read_sql_query(session.query(query_sponsors).statement, engine)

df_final = pd.merge(df_perf, df_money, on='id_chomika', how='left').fillna(0)
```

```{python}
#| label: fig-money-dropdown
#| fig-cap: "Zależność sponsoringu od wyników"
#| echo: false

fig = go.Figure()

dyscypliny = df_final['nazwa_konkurencji'].unique()

for dyscyplina in dyscypliny:
    df_temp = df_final[df_final['nazwa_konkurencji'] == dyscyplina]
    
    fig.add_trace(
        go.Scatter(
            x=df_temp['suma_sponsoringu'],
            y=df_temp['sredni_czas'],
            mode='markers',
            name=dyscyplina,
            text=df_temp['imie'],
            visible=False,
            marker=dict(size=8, opacity=0.6, line=dict(width=1, color='DarkSlateGrey'))
        )
    )

if len(fig.data) > 0:
    fig.data[0].visible = True

buttons = []
for i, dyscyplina in enumerate(dyscypliny):
    visibility = [False] * len(dyscypliny)
    visibility[i] = True
    button = dict(
        label=dyscyplina,
        method="update",
        args=[{"visible": visibility},
              {"title": f"Sponsoring vs Czas: {dyscyplina}"}]
    )
    buttons.append(button)
fig.update_layout(
    updatemenus=[
        dict(
            active=0,
            buttons=buttons,
            x=1.0,
            y=1.15
        )
    ],
    title=f"Sponsoring vs Czas: {dyscypliny[0] if len(dyscypliny)>0 else ''}",
    xaxis_title="Suma kontraktów sponsorskich (PLN)",
    yaxis_title="Średni czas (s)",
    margin=dict(t=50, l=25, r=25, b=25)
)

fig.show()
```

Okazuje się, że pieniądze nie mają decydującego wpływu na wyniki zawodników niezależnie od dyscypliny. Bardzo dobrze finansowane chomiki (powyżej 0.6 mln PLN) osiągają często czasy przeciętne, co sugeruje, że budżet nie przekłada się na formę sportową.

### 4. Popularność sportu i finanse

Analiza liczby uczestników zawodów w czasie oraz kondycja finansowa federacji.

```{python}
#| label: popularity_finance
#| include: false

query_pop = session.query(
    Zawody.data_zawodow,
    sa.func.count(Wyniki.id_chomika).label('liczba_uczestnikow')
).join(Wyniki, Zawody.id_zawodow == Wyniki.id_zawodow)\
 .group_by(Zawody.data_zawodow)\
 .order_by(Zawody.data_zawodow)

df_pop = pd.read_sql_query(query_pop.statement, engine)

# Obliczenia do opisu tekstowego
pula = session.query(sa.func.sum(Zawody.pula_nagrod)).scalar()
finans = session.query(sa.func.sum(Finansowanie.kwota)).scalar()
spons = session.query(sa.func.sum(SponsorzyUmowy.kwota)).scalar()
przychody = finans + spons
```

```{python}
#| label: fig-pop-fin
#| fig-cap: "Liczba uczestników zawodów w czasie"
#| echo: false

fig1 = px.line(df_pop, x='data_zawodow', y='liczba_uczestnikow', title="Dynamika frekwencji na zawodach")
fig1.show()
```

Liczba uczestników w zawodach notuje sporą zmienność. W ostatnich latach (po 2020 r., jak i po 2016 r.) widoczny jest wyraźny dołek i spadek liczby zawodników poniżej 60 na zawody.

Pod kątem finansowym federacja jest jednak w doskonałej kondycji. Przychody całkowite (sponsoring i dotacje) wynoszą ponad **`{python} f"{przychody:,.0f}"` PLN**, co niemal trzykrotnie przewyższa główne koszty operacyjne, jakimi są pule nagród (**`{python} f"{pula:,.0f}"` PLN**). Oznacza to, że sport chomiczy jest wysoce skomercjalizowany i generuje potężne nadwyżki budżetowe.

### 5. Gdzie leżą największe pieniądze?

Poniższy wykres przedstawia, które miasta inwestują najwięcej w organizację zawodów oraz jakie dyscypliny generują największe pule nagród. 

```{python}
#| label: fig-prize-treemap
#| fig-cap: "Mapa puli nagród"
#| echo: false

query_prize = session.query(
    Zawody.lokalizacja,
    Konkurencje.nazwa_konkurencji,
    sa.func.sum(Zawody.pula_nagrod).label('suma_nagrod')
).join(Konkurencje, Zawody.id_konkurencji == Konkurencje.id_konkurencji)\
 .group_by(Zawody.lokalizacja, Konkurencje.nazwa_konkurencji)

df_prize = pd.read_sql_query(query_prize.statement, engine)

fig = px.treemap(df_prize, 
                 path=['lokalizacja', 'nazwa_konkurencji'], 
                 values='suma_nagrod',
                 color='suma_nagrod',
                 color_continuous_scale='Greens',
                 title="Mapa Finansowa: Pula nagród wg Miast i Dyscyplin")

fig.update_traces(textinfo="label+value+percent parent")
fig.show()
```

### 6. Skuteczność kontroli antydopingowych

Analiza wyników kontroli antydopingowych oraz profil najczęściej wykrywanych substancji zakazanych.

```{python}
#| label: fig-control
#| fig-cap: "Wyniki kontroli i wykryte substancje"
#| echo: false

query_control = session.query(
    Kontrole.wynik_kontroli,
    sa.func.count(Kontrole.id_kontroli).label('liczba')
).group_by(Kontrole.wynik_kontroli)

df_control = pd.read_sql_query(query_control.statement, engine)

df_control['wynik_opis'] = df_control['wynik_kontroli'].map({0: 'Negatywny (Czysty)', 1: 'Pozytywny (Doping)'})

WynikiKontroli = Base.classes.wyniki_kontroli
query_substances = session.query(
    WynikiKontroli.substancje_zakazane,
    sa.func.count(WynikiKontroli.id_kontroli).label('liczba')
).group_by(WynikiKontroli.substancje_zakazane)

df_substances = pd.read_sql_query(query_substances.statement, engine)

fig = make_subplots(rows=1, cols=2, specs=[[{'type':'domain'},{'type':'domain'}]],
                    subplot_titles=['Ogólne wyniki kontroli', 'Najczęściej wykrywane substancje'])

fig.add_trace(go.Pie(labels=df_control['wynik_opis'], 
                     values=df_control['liczba'], 
                     marker=dict(colors=['#2ca02c', '#d62728']),
                     textinfo='percent+label', 
                     textposition='inside'), 
              row=1, col=1)

fig.add_trace(go.Pie(labels=df_substances['substancje_zakazane'], 
                     values=df_substances['liczba'],
                     textinfo='percent+label', 
                     textposition='inside'), 
              row=1, col=2)

fig.update_layout(
    showlegend=False,
    height=500,
    margin=dict(t=50, b=50, l=20, r=20)
)
fig.show()
```

System antydopingowy działa skutecznie, a problem ma charakter marginalny – **nieco ponad 3% kontroli daje wynik pozytywny**. Oznacza to, że około 97% stawki rywalizuje zgodnie z zasadami fair play.

Mimo niskiego odsetka oszustw, substancje wykrywane u tych 3% chomików są niezwykle inwazyjne. Rynek zdominowany jest przez dwa typy środków:

* **Silne stymulanty układu nerwowego:** Pseudoefedryna, Amfetamina czy Kokaina, służące do maksymalnego pobudzenia przed startem.
* **Sterydy anaboliczno-androgenne:** Stanozolol, Nandrolon czy Trenbolon, budujące nienaturalną masę mięśniową i siłę.

Świadczy to o tym, że doping nie jest przypadkowy (nie są to losowe zanieczyszczenia karmy), lecz jest to zaawansowany, celowy proceder.

### 7. Analiza Fizjonomii

Czy budowa ciała (waga i wzrost) ma kluczowy wpływ na osiągany czas? Wykres 3D pozwala nam zaobserwować najlepszych zawodników w przestrzeni cech fizycznych.

```{python}
#| label: fig-3d-analysis
#| fig-cap: "Aaliza cech fizycznych a wynik sportowy"
#| echo: false

query_3d = session.query(
    Chomiki.waga,
    Chomiki.wzrost,
    Wyniki.czas,
    Chomiki.rasa
).join(Wyniki, Chomiki.id_chomika == Wyniki.id_chomika)

df_3d = pd.read_sql_query(query_3d.statement, engine)

fig = px.scatter_3d(df_3d, x='waga', y='wzrost', z='czas', color='rasa',
                    opacity=0.7, 
                    title="Zależność: Waga vs Wzrost vs Czas",
                    labels={'waga': 'Waga (g)', 'wzrost': 'Wzrost (cm)', 'czas': 'Czas (s)'})

fig.update_traces(marker_size=4)
fig.update_layout(margin=dict(l=0, r=0, b=0, t=30))
fig.show()
```

Wykres powyżej pokazuje, że waga oraz wzrost chomików nie mają bezpośredniego wpływu na osiągany przez nie czas. Żadna z ras, niezależnie od swoich gabarytów (czy to malutki chomik roborowski, czy duży chomik europejski), nie zyskuje naturalnej przewagi fizycznej w tych konkretnych zawodach. Sukces zależy zatem od innych czynników, np. ukrytego talentu lub wytrenowania.

### 8. Co decyduje o sukcesie?

Analiza korelacji pomiędzy mierzalnymi parametrami.

* Wartość bliska **1** lub **-1** oznacza silną zależność.
* Wartość bliska **0** oznacza brak związku.

```{python}
#| label: correlation-matrix
#| fig-cap: "Macierz korelacji zmiennych"
#| echo: false

query_phys = session.query(
    Chomiki.id_chomika,
    Chomiki.data_urodzenia,
    Chomiki.waga,
    Chomiki.wzrost,
    Wyniki.czas,
    Zawody.data_zawodow
).join(Wyniki, Chomiki.id_chomika == Wyniki.id_chomika)\
 .join(Zawody, Wyniki.id_zawodow == Zawody.id_zawodow)

df_main = pd.read_sql_query(query_phys.statement, engine)

df_main['wiek_dni'] = (pd.to_datetime(df_main['data_zawodow']) - pd.to_datetime(df_main['data_urodzenia'])).dt.days

query_money = session.query(
    SponsorzyUmowy.id_chomika,
    sa.func.sum(SponsorzyUmowy.kwota).label('finansowanie')
).group_by(SponsorzyUmowy.id_chomika)

df_money = pd.read_sql_query(query_money.statement, engine)

df_full = pd.merge(df_main, df_money, on='id_chomika', how='left').fillna(0)

cols_to_corr = ['czas', 'waga', 'wzrost', 'wiek_dni', 'finansowanie']
corr_matrix = df_full[cols_to_corr].corr()

fig = px.imshow(corr_matrix, 
                text_auto=True, 
                aspect="auto", 
                color_continuous_scale='RdBu_r',
                title="Macierz Korelacji: Co wpływa na czas?")
fig.show()
```

Macierz powyżej potwierdza, że żadna z badanych zmiennych nie jest ze sobą silnie powiązana. Wszystkie współczynniki w macierzy (poza przekątną) oscylują bardzo blisko zera (w przedziale od -0.04 do +0.02). Skoro żaden z mierzonych parametrów ie wpływa na czas, oznacza to, że o sukcesie w federacji decydują czynniki niemierzalne – wrodzony talent, łut szczęścia lub chwilowa dyspozycja (lub niedyspozycja) danego dnia.

```{python}
#| label: session_close
#| include: false
session.close()
```